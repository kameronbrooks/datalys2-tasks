<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datalys2 Tasks Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .table th { background-color: #f1f3f5; }
        .status-Ready { color: #28a745; font-weight: bold; }
        .status-Running { color: #007bff; font-weight: bold; }
        .status-Disabled { color: #6c757d; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-tasks text-primary"></i> Datalys2 Scheduler</h2>
        <button class="btn btn-primary" onclick="fetchTasks()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
    
    <div class="card">
        <div class="card-header bg-white py-3">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <h5 class="mb-0">Scheduled Tasks</h5>
                </div>
                <div class="col">
                    <input type="text" id="taskSearch" class="form-control form-control-sm" placeholder="Search tasks..." onkeyup="handleTaskSearch()">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tasksTable">
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Status</th>
                            <th>Next Run</th>
                            <th>Last Run</th>
                            <th>Last Result</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasksBody">
                        <tr><td colspan="6" class="text-center p-4">Loading tasks...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <small class="text-muted" id="taskCounts">Showing 0-0 of 0</small>
            <nav aria-label="Task pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" id="taskPrevBtn"><button class="page-link" onclick="changeTaskPage(-1)">Previous</button></li>
                    <li class="page-item active"><span class="page-link" id="taskPageNum">1</span></li>
                    <li class="page-item" id="taskNextBtn"><button class="page-link" onclick="changeTaskPage(1)">Next</button></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-header bg-light py-3">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <h5 class="mb-0">Execution History</h5>
                </div>
                <div class="col">
                    <input type="text" id="historySearch" class="form-control form-control-sm" placeholder="Search history..." onkeyup="handleHistorySearch()">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Function</th>
                            <th>Status</th>
                            <th>Result</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="5" class="text-center p-4">Loading history...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <small class="text-muted" id="historyCounts">Page 1</small>
            <nav aria-label="History pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" id="histPrevBtn"><button class="page-link" onclick="changeHistoryPage(-1)">Previous</button></li>
                    <li class="page-item active"><span class="page-link" id="histPageNum">1</span></li>
                    <li class="page-item" id="histNextBtn"><button class="page-link" onclick="changeHistoryPage(1)">Next</button></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    async function fetchTasks() {
        const tbody = document.getElementById('tasksBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></td></tr>';
        
        try {
            const response = await fetch('/api/scheduled-tasks/');
            const tasks = await response.json();
            
            tbody.innerHTML = '';
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No scheduled tasks found in \\datalys2\\</td></tr>';
                return;
            }

            tasks.forEach(task => {
                const tr = document.createElement('tr');
                const safeName = encodeURIComponent(task.name);
                
                tr.innerHTML = `
                    <td>
                        <div class="fw-bold">${task.short_name}</div>
                        <small class="text-muted" style="font-size:0.75em">${task.name}</small>
                    </td>
                    <td><span class="status-${task.status.split(" ")[0]}">${task.status}</span></td>
                    <td>${task.next_run_time}</td>
                    <td>${task.last_run_time}</td>
                    <td><code>${task.last_result}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="runTask('${safeName}')" title="Run Now">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${safeName}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error fetching tasks:', error);
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger p-4">Error loading tasks: ${error.message}</td></tr>`;
        }
    }

    async function runTask(taskName) {
        if(!confirm(`Run task now?`)) return;
        try {
            const response = await fetch(`/api/scheduled-tasks/${taskName}/run`, { method: 'POST' });
            if (response.ok) {
                alert('Task triggered successfully!');
                setTimeout(fetchTasks, 1000); // Wait a bit for status update
            } else {
                const err = await response.json();
                alert('Failed: ' + err.detail);
            }
        } catch (e) {
            alert('Error: ' + e);
        }
    }

    async function deleteTask(taskName) {
        if(!confirm('Are you sure you want to delete this task? This cannot be undone.')) return;
        try {
            const response = await fetch(`/api/scheduled-tasks/${taskName}`, { method: 'DELETE' });
            if (response.ok) {
                fetchTasks();
            } else {
                const err = await response.json();
                alert('Failed: ' + err.detail);
            }
        } catch (e) {
            alert('Error: ' + e);
        }
    }

    async function fetchHistory() {
        const tbody = document.getElementById('historyBody');
        if (!tbody) return;
        
        try {
            const response = await fetch('/tasks');
            const tasks = await response.json();
            
            tbody.innerHTML = '';
            
            tasks.forEach(task => {
                const tr = document.createElement('tr');
                let resultDisplay = '';
                if (task.status === 'COMPLETED') {
                    resultDisplay = task.result ? task.result.substring(0, 100) : '';
                } else if (task.status === 'FAILED') {
                    resultDisplay = task.error ? task.error.substring(0, 100) + '...' : '';
                }
                
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td><div class="fw-bold">${task.function_name}</div><small class="text-muted" style="font-size:0.75em">${task.module_path}</small></td>
                    <td><span class="badge ${getStatusBadgeClass(task.status)}">${task.status}</span></td>
                    <td><code style="font-size:0.8em">${resultDisplay}</code></td>
                    <td><small>${new Date(task.created_at).toLocaleString()}</small></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error fetching history:', error);
        }
    }

    function getStatusBadgeClass(status) {
        if (status === 'COMPLETED') return 'bg-success';
        if (status === 'FAILED') return 'bg-danger';
        if (status === 'RUNNING') return 'bg-warning text-dark';
        return 'bg-secondary';
    }

    // Initial load
    fetchTasks();
    fetchHistory();

</script>

</body>
</html>
